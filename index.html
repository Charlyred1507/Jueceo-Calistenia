<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Detector de Movimiento Calistenia</title>
<style>
  body { margin: 0; background: #111; color: #fff; font-family: 'Poppins', sans-serif;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    height: 100vh; overflow: hidden; }
  video, canvas { position: absolute; top:50%; left:50%; transform:translate(-50%,-50%);
    width:100%; height:auto; max-height:100vh; border-radius:12px; object-fit:cover; }
  #status { position:absolute; bottom:20px; background:rgba(0,0,0,0.7); padding:10px 20px;
    border-radius:8px; font-size:1rem; z-index:10; }
  #startBtn { position:absolute; top:20px; background:#28a745; border:none; color:white;
    padding:12px 24px; border-radius:8px; font-size:1rem; cursor:pointer; z-index:10; }
  #exerciseSelect { position:absolute; top:70px; background:#222; border:none; color:white;
    padding:8px 16px; border-radius:8px; font-size:1rem; z-index:10; }
  #counter { position:absolute; top:120px; font-size:1.5rem; background:rgba(0,0,0,0.7);
    padding:8px 16px; border-radius:8px; z-index:10; }
</style>
</head>
<body>
<button id="startBtn">Activar C√°mara</button>
<select id="exerciseSelect">
  <option value="pushup">Push-ups</option>
  <option value="dip">Fondos</option>
  <option value="squat">Squats</option>
  <option value="pullup">Pull-ups</option>
</select>
<div id="counter">Reps: 0</div>
<video id="video" playsinline autoplay muted></video>
<canvas id="output"></canvas>
<div id="status">Esperando c√°mara...</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('output');
const ctx = canvas.getContext('2d');
const statusEl = document.getElementById('status');
const startBtn = document.getElementById('startBtn');
const exerciseSelect = document.getElementById('exerciseSelect');
const counterEl = document.getElementById('counter');

let detector;
let reps = 0, up = false, inPosition = false, passedMin = false;
let currentExercise = exerciseSelect.value;
let feedbackMessage = "", feedbackTimer = null;
let movementBufferY = [];

function showFeedback(msg,duration=1500){
  if(feedbackMessage!==msg){
    feedbackMessage=msg;
    statusEl.textContent=msg;
    if(feedbackTimer) clearTimeout(feedbackTimer);
    feedbackTimer = setTimeout(()=>{ feedbackMessage=""; statusEl.textContent=""; }, duration);
  }
}

exerciseSelect.addEventListener('change', ()=>{
  currentExercise=exerciseSelect.value;
  reps=0; up=false; inPosition=false; passedMin=false; movementBufferY=[];
  counterEl.textContent="Reps: 0";
  showFeedback(`Ejercicio seleccionado: ${currentExercise}`,2000);
});

startBtn.addEventListener('click', initCamera);

async function initCamera(){
  showFeedback("Iniciando c√°mara...");
  startBtn.disabled=true;
  try{
    const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    video.srcObject=stream;
    await new Promise(res=>video.onloadedmetadata=res);
    canvas.width=video.videoWidth;
    canvas.height=video.videoHeight;
    showFeedback("C√°mara activa ‚úÖ");
    await initDetector();
    detectPose();
  } catch(err){
    console.error(err);
    showFeedback("‚ùå No se pudo acceder a la c√°mara");
    startBtn.disabled=false;
  }
}

async function initDetector(){
  showFeedback("Cargando detector...");
  detector = await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet,{
    modelType:poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING
  });
  showFeedback("Detector activo ‚úÖ",1500);
}

function getAngle(a,b,c){
  if(!a||!b||!c) return 180;
  const AB={x:b.x-a.x, y:b.y-a.y};
  const CB={x:b.x-c.x, y:b.y-c.y};
  const dot=AB.x*CB.x+AB.y*CB.y;
  const magAB=Math.sqrt(AB.x**2+AB.y**2);
  const magCB=Math.sqrt(CB.x**2+CB.y**2);
  return Math.round(Math.acos(dot/(magAB*magCB))*180/Math.PI);
}

function isStable(y,threshold=20,frames=15){
  if(y===undefined) return false;
  movementBufferY.push(y);
  if(movementBufferY.length>frames) movementBufferY.shift();
  return (Math.max(...movementBufferY)-Math.min(...movementBufferY))<threshold;
}

function detectReps(kp){
  const shoulder = kp[11], hip=kp[23], knee=kp[25], ankle=kp[27];
  const tolerance=0.3; //30%
  switch(currentExercise){
    case "squat":
      if(hip && knee && ankle && shoulder){
        const kneeAngle=getAngle(hip,knee,ankle);
        const hipAngle=getAngle(shoulder,hip,knee);
        const yAvg=(hip.y+knee.y)/2;
        if(!inPosition){
          if(kneeAngle>=165*(1-tolerance) && hipAngle>=160*(1-tolerance) && isStable(yAvg)){
            inPosition=true;
            passedMin=false;
            showFeedback("üü¢ Posici√≥n inicial correcta: empieza tu squat");
          } else {
            showFeedback("Coloca torso recto y piernas extendidas");
          }
        } else {
          if(kneeAngle<=117*(1+tolerance)) passedMin=true;
          if(kneeAngle>=165*(1-tolerance) && passedMin){
            reps++; up=false; passedMin=false;
            showFeedback("‚úÖ Repetici√≥n v√°lida");
          } else if(kneeAngle>=165*(1-tolerance) && !passedMin){
            showFeedback("‚ùå No rep: baja m√°s las rodillas");
          }
        }
      }
      break;

    // Mantener l√≥gica anterior para pushup, dip, pullup
    case "pushup":
      const s=kp[11], e=kp[13], w=kp[15];
      if(s && e && w){
        const angle=getAngle(s,e,w);
        const yAvg=(s.y+e.y)/2;
        if(!inPosition){
          if(angle>165 && Math.abs(s.y-w.y)<20 && isStable(yAvg)){
            inPosition=true; showFeedback("üü¢ Listo para empezar");
          } else showFeedback("Extiende brazos y torso estable");
        } else {
          if(angle<80 && !up) up=true;
          if(angle>160 && up){ reps++; up=false; showFeedback("‚úÖ Repetici√≥n v√°lida"); }
          else if(angle>160 && !up){ showFeedback("‚ùå No rep: baja m√°s el cuerpo"); }
        }
      }
      break;

    case "dip":
      const sh=kp[11], el=kp[13], wr=kp[15], hp=kp[23];
      if(sh && el && wr && hp){
        const angle=getAngle(sh,el,wr);
        const yAvg=(hp.y+el.y)/2;
        if(!inPosition){