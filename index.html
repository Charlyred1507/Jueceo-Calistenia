<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jueceo Calistenia IA - PRO UX</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.3.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@0.0.7/dist/pose-detection.min.js"></script>

<style>
body { margin:0; padding:0; background:#111; font-family:sans-serif; color:white; display:flex; flex-direction:column; align-items:center; }
h1 { margin-top:15px; font-size:1.8rem; text-align:center; }
#videoContainer { position:relative; width:100%; max-width:640px; display:flex; justify-content:center; align-items:center; margin-top:10px; }
video, canvas { border-radius:12px; width:100%; height:auto; object-fit:cover; }
#overlay { position:absolute; top:10px; left:50%; transform:translateX(-50%); text-align:center; z-index:10; width:95%; pointer-events:none; }
#exercise { font-size:2rem; font-weight:bold; color:#00ff88; margin-bottom:5px; text-shadow:1px 1px 4px black; }
#counters { display:flex; gap:10px; justify-content:center; font-size:1.2rem; flex-wrap:wrap; margin-bottom:10px; text-shadow:1px 1px 3px black; }
button { font-size:1rem; padding:10px 15px; margin:5px; border:none; border-radius:10px; cursor:pointer; background:#00ff88; color:#111; font-weight:bold; transition:all 0.2s ease; }
button:active { transform:scale(0.95); background:#ffaa00; }
#controls { display:flex; flex-wrap:wrap; justify-content:center; margin-top:15px; margin-bottom:20px; gap:10px; z-index:10; }
#repCounter { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:4rem; font-weight:bold; color:#ffdd00; text-shadow:2px 2px 8px black; pointer-events:none; }
#feedback { position:absolute; bottom:10px; left:50%; transform:translateX(-50%); font-size:1.2rem; font-weight:bold; color:#00ff88; text-shadow:1px 1px 4px black; z-index:15; }
</style>
</head>
<body>
<h1>üí™ Jueceo Calistenia IA</h1>

<div id="videoContainer">
  <video id="video" playsinline autoplay muted></video>
  <canvas id="canvas"></canvas>
  <div id="overlay">
    <div id="exercise">Ejercicio: ---</div>
    <div id="counters">
      <span>üí™ Lagartijas: 0</span>
      <span>üèãÔ∏è Sentadillas: 0</span>
      <span>üîù Muscle-ups: 0</span>
      <span>‚¨ÜÔ∏è Pull-ups: 0</span>
    </div>
  </div>
  <div id="repCounter">0</div>
  <div id="feedback"></div>
</div>

<div id="controls">
  <button id="startCamera">Activar C√°mara</button>
  <button id="addPushup">Agregar Ejemplo Lagartija</button>
  <button id="addSquat">Agregar Ejemplo Sentadilla</button>
  <button id="addMuscleup">Agregar Ejemplo Muscle-up</button>
  <button id="addPullup">Agregar Ejemplo Pull-up</button>
  <button id="train">Entrenar Modelo</button>
</div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const exerciseText = document.getElementById('exercise');
const countersElements = document.querySelectorAll("#counters span");
const repCounterEl = document.getElementById('repCounter');
const startCameraBtn = document.getElementById('startCamera');
const feedbackEl = document.getElementById('feedback');

let detector;

let counts = { pushup:0, squat:0, muscleup:0, pullup:0 };
let states = { pushupDown:false, squatDown:false, muscleupDown:false, pullupDown:false };

function resizeCanvas(){ canvas.width=video.videoWidth; canvas.height=video.videoHeight; }

function drawPose(keypoints){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const connections = [
    ['left_shoulder','left_elbow'], ['left_elbow','left_wrist'],
    ['right_shoulder','right_elbow'], ['right_elbow','right_wrist'],
    ['left_hip','left_knee'], ['left_knee','left_ankle'],
    ['right_hip','right_knee'], ['right_knee','right_ankle'],
    ['left_shoulder','right_shoulder'], ['left_hip','right_hip']
  ];
  connections.forEach(c=>{
    const p1=keypoints.find(k=>k.name===c[0]);
    const p2=keypoints.find(k=>k.name===c[1]);
    if(p1 && p2 && p1.score>0.3 && p2.score>0.3){
      ctx.strokeStyle="#00FFAA"; ctx.lineWidth=3;
      ctx.beginPath();
      ctx.moveTo(p1.x*canvas.width,p1.y*canvas.height);
      ctx.lineTo(p2.x*canvas.width,p2.y*canvas.height);
      ctx.stroke();
    }
  });
}

function calcAngle(a,b,c){
  const rad=Math.atan2(c.y-b.y,c.x-b.x)-Math.atan2(a.y-b.y,a.x-b.x);
  let ang=Math.abs(rad*180/Math.PI);
  if(ang>180) ang=360-ang; 
  return ang;
}

async function detectLoop(){
  if(!detector) return;
  const poses = await detector.estimatePoses(video);
  if(poses.length>0){
    const keypoints=poses[0].keypoints;
    drawPose(keypoints);

    // Lagartijas
    const lS=keypoints.find(k=>k.name==='left_shoulder');
    const lE=keypoints.find(k=>k.name==='left_elbow');
    const lW=keypoints.find(k=>k.name==='left_wrist');
    const rS=keypoints.find(k=>k.name==='right_shoulder');
    const rE=keypoints.find(k=>k.name==='right_elbow');
    const rW=keypoints.find(k=>k.name==='right_wrist');
    if(lS&&lE&&lW&&rS&&rE&&rW){
      const angleL=calcAngle(lS,lE,lW);
      const angleR=calcAngle(rS,rE,rW);
      const down=angleL<100 && angleR<100;
      if(down && !states.pushupDown) counts.pushup++;
      states.pushupDown=down;
    }

    // Sentadillas
    const lH=keypoints.find(k=>k.name==='left_hip');
    const lK=keypoints.find(k=>k.name==='left_knee');
    const lA=keypoints.find(k=>k.name==='left_ankle');
    const rH=keypoints.find(k=>k.name==='right_hip');
    const rK=keypoints.find(k=>k.name==='right_knee');
    const rA=keypoints.find(k=>k.name==='right_ankle');
    if(lH&&lK&&lA&&rH&&rK&&rA){
      const angleL=calcAngle(lH,lK,lA);
      const angleR=calcAngle(rH,rK,rA);
      const down=angleL<100 && angleR<100;
      if(down && !states.squatDown) counts.squat++;
      states.squatDown=down;
    }

    countersElements[0].textContent=`üí™ Lagartijas: ${counts.pushup}`;
    countersElements[1].textContent=`üèãÔ∏è Sentadillas: ${counts.squat}`;
    countersElements[2].textContent=`üîù Muscle-ups: ${counts.muscleup}`;
    countersElements[3].textContent=`‚¨ÜÔ∏è Pull-ups: ${counts.pullup}`;

    const maxCount = Math.max(counts.pushup,counts.squat,counts.muscleup,counts.pullup);
    repCounterEl.textContent = maxCount;
    if(maxCount===counts.pushup) exerciseText.textContent="Ejercicio: Lagartija";
    else if(maxCount===counts.squat) exerciseText.textContent="Ejercicio: Sentadilla";
    else if(maxCount===counts.muscleup) exerciseText.textContent="Ejercicio: Muscle-up";
    else if(maxCount===counts.pullup) exerciseText.textContent="Ejercicio: Pull-up";
  }
  requestAnimationFrame(detectLoop);
}

// Activar c√°mara
async function startCamera(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    video.srcObject=stream;
    await video.play();
    resizeCanvas();
    detector = await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet);
    detectLoop();
  }catch(err){ console.error(err); alert("No se pudo activar la c√°mara."); }
}
startCameraBtn.addEventListener('click', startCamera);

// Botones con feedback visual
function buttonFeedback(msg){
  feedbackEl.textContent = msg;
  feedbackEl.style.opacity = 1;
  setTimeout(()=>{ feedbackEl.style.opacity=0; },1200);
}

document.getElementById('addPushup').addEventListener('click', ()=>buttonFeedback("Ejemplo Lagartija agregado"));
document.getElementById('addSquat').addEventListener('click', ()=>buttonFeedback("Ejemplo Sentadilla agregado"));
document.getElementById('addMuscleup').addEventListener('click', ()=>buttonFeedback("Ejemplo Muscle