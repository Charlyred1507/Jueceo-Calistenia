<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jueceo Calistenia IA - UI/UX Mejorado</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.3.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@0.0.7/dist/pose-detection.min.js"></script>

<style>
body { margin:0; padding:0; background:#111; font-family:sans-serif; color:white; display:flex; flex-direction:column; align-items:center; }
video, canvas { border-radius:12px; margin-top:10px; max-width:100%; }
#overlay { position:absolute; top:10px; left:50%; transform:translateX(-50%); text-align:center; z-index:10; }
#status { font-size:1rem; margin-bottom:5px; }
#exercise { font-size:1.5rem; font-weight:bold; margin-bottom:5px; color:#00ff88; }
#counters { display:flex; gap:15px; justify-content:center; font-size:1.2rem; margin-bottom:10px; flex-wrap:wrap; }
button { font-size:1rem; padding:10px 15px; margin:5px; border:none; border-radius:10px; cursor:pointer; background:#00ff88; color:#111; font-weight:bold; }
#controls { display:flex; flex-wrap:wrap; justify-content:center; margin-top:10px; z-index:10; position:relative; }
canvas { position:relative; z-index:1; }
#videoContainer { position:relative; width:100%; max-width:600px; display:flex; justify-content:center; align-items:center; }
</style>
</head>
<body>
<h1>üí™ Jueceo Calistenia IA</h1>

<div id="videoContainer">
<video id="video" playsinline autoplay muted></video>
<canvas id="canvas"></canvas>
<div id="overlay">
  <div id="status">C√°mara apagada</div>
  <div id="exercise">Ejercicio: ---</div>
  <div id="counters">
    <span>üí™ Lagartijas: 0</span>
    <span>üèãÔ∏è Sentadillas: 0</span>
    <span>üîù Muscle-ups: 0</span>
    <span>‚¨ÜÔ∏è Pull-ups: 0</span>
  </div>
</div>
</div>

<div id="controls">
<button id="startCamera">Activar c√°mara</button>
<button id="addPushup">Agregar ejemplo Lagartija</button>
<button id="addSquat">Agregar ejemplo Sentadilla</button>
<button id="addMuscleup">Agregar ejemplo Muscle-up</button>
<button id="addPullup">Agregar ejemplo Pull-up</button>
<button id="train">Entrenar Modelo</button>
</div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const statusText = document.getElementById('status');
const exerciseText = document.getElementById('exercise');
const countersElements = document.querySelectorAll("#counters span");
const startCameraBtn = document.getElementById('startCamera');

let detector;
let model;

let counts = { pushup:0, squat:0, muscleup:0, pullup:0 };
let states = { pushupDown:false, squatDown:false, muscleupDown:false, pullupDown:false };
let trainingData = [];
let trainingLabels = [];

function getKeypointVector(keypoints){
  return keypoints.map(k=>[k.x,k.y]).flat();
}

function drawPose(keypoints){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const connections = [
    ['left_shoulder','left_elbow'], ['left_elbow','left_wrist'],
    ['right_shoulder','right_elbow'], ['right_elbow','right_wrist'],
    ['left_hip','left_knee'], ['left_knee','left_ankle'],
    ['right_hip','right_knee'], ['right_knee','right_ankle'],
    ['left_shoulder','right_shoulder'], ['left_hip','right_hip']
  ];
  ctx.strokeStyle="#00FFAA"; ctx.lineWidth=2;
  connections.forEach(c=>{
    const p1 = keypoints.find(k=>k.name===c[0]);
    const p2 = keypoints.find(k=>k.name===c[1]);
    if(p1 && p2 && p1.score>0.3 && p2.score>0.3){
      ctx.beginPath();
      ctx.moveTo(p1.x*canvas.width,p1.y*canvas.height);
      ctx.lineTo(p2.x*canvas.width,p2.y*canvas.height);
      ctx.stroke();
    }
  });
}

async function predictExercise(keypoints){
  if(!model) return "---";
  const input = tf.tensor([getKeypointVector(keypoints)]);
  const pred = model.predict(input);
  const classIdx = pred.argMax(-1).dataSync()[0];
  input.dispose(); pred.dispose();
  switch(classIdx){
    case 0: return "Lagartija";
    case 1: return "Sentadilla";
    case 2: return "Muscle-up";
    case 3: return "Pull-up";
    default: return "---";
  }
}

function calcAngle(a,b,c){
  const rad=Math.atan2(c.y-b.y,c.x-b.x)-Math.atan2(a.y-b.y,a.x-b.x);
  let ang=Math.abs(rad*180/Math.PI);
  if(ang>180) ang=360-ang;
  return ang;
}

async function detectLoop(){
  if(!detector) return;
  const poses = await detector.estimatePoses(video);
  if(poses.length>0){
    const keypoints = poses[0].keypoints;
    drawPose(keypoints);
    const predicted = await predictExercise(keypoints);
    exerciseText.textContent = "Ejercicio: "+predicted;

    // Lagartijas
    const lS=keypoints.find(k=>k.name==='left_shoulder');
    const lE=keypoints.find(k=>k.name==='left_elbow');
    const lW=keypoints.find(k=>k.name==='left_wrist');
    const rS=keypoints.find(k=>k.name==='right_shoulder');
    const rE=keypoints.find(k=>k.name==='right_elbow');
    const rW=keypoints.find(k=>k.name==='right_wrist');
    if(lS && lE && lW && rS && rE && rW){
      const angleL=calcAngle(lS,lE,lW);
      const angleR=calcAngle(rS,rE,rW);
      const down=angleL<100 && angleR<100;
      if(down && !states.pushupDown) counts.pushup++;
      states.pushupDown=down;
    }

    // Sentadillas
    const lH=keypoints.find(k=>k.name==='left_hip');
    const lK=keypoints.find(k=>k.name==='left_knee');
    const lA=keypoints.find(k=>k.name==='left_ankle');
    const rH=keypoints.find(k=>k.name==='right_hip');
    const rK=keypoints.find(k=>k.name==='right_knee');
    const rA=keypoints.find(k=>k.name==='right_ankle');
    if(lH && lK && lA && rH && rK && rA){
      const angleL=calcAngle(lH,lK,lA);
      const angleR=calcAngle(rH,rK,rA);
      const down=angleL<100 && angleR<100;
      if(down && !states.squatDown) counts.squat++;
      states.squatDown=down;
    }

    // Muscle-ups y Pull-ups
    const yShoulder=(keypoints.find(k=>k.name==='left_shoulder')?.y + keypoints.find(k=>k.name==='right_shoulder')?.y)/2;
    const yHip=(keypoints.find(k=>k.name==='left_hip')?.y + keypoints.find(k=>k.name==='right_hip')?.y)/2;
    const muscleDown = yHip > yShoulder*1.1;
    const pullDown = yHip > yShoulder*1.2;

    if(muscleDown && !states.muscleupDown) counts.muscleup++;
    if(pullDown && !states.pullupDown) counts.pullup++;
    states.muscleupDown=muscleDown;
    states.pullupDown=pullDown;

    // Actualizar contadores visibles
    countersElements[0].textContent=`üí™ Lagartijas: ${counts.pushup}`;
    countersElements[1].textContent=`üèãÔ∏è Sentadillas: ${counts.squat}`;
    countersElements[2].textContent=`üîù Muscle-ups: ${counts.muscleup}`;
    countersElements[3].textContent=`‚¨ÜÔ∏è Pull-ups: ${counts.pullup}`;
  }
  requestAnimationFrame(detectLoop);
}

// Botones de entrenamiento
const exerciseButtons = [
  {id:'addPushup',label:0},
  {id:'addSquat',label:1},
  {id:'addMuscleup',label:2},
  {id:'addPullup',label:3}
];
exerciseButtons.forEach(b=>{
  document.getElementById(b.id).addEventListener('click',async()=>{
    if(!detector) { statusText.textContent="Activa la c√°mara primero"; return; }
    const poses = await detector.estimatePoses(video);
    if(poses.length>0){ trainingData.push(getKeypointVector(poses[0].keypoints)); trainingLabels.push(b.label); statusText.textContent=`Ejemplo agregado ‚úÖ (${b.id})`; }
  });
});

// Entrenar modelo
document.getElementById('train').addEventListener('click',async()=>{
  if(trainingData.length<4){ statusText.textContent="Agrega m√°s ejemplos"; return; }
  const xs = tf.tensor(trainingData);
  const ys = tf.tensor(trainingLabels.map(l=>[l]));
  model = tf.sequential();
  model.add(tf.layers.dense({units:128,inputShape:[xs.shape[1]],activation:'relu'}));
  model.add(tf.layers.dense({units:64,activation:'relu'}));
  model.add(tf.layers.dense({units:4,activation:'softmax'}));
  model.compile({optimizer:'adam',loss:'sparseCategoricalCrossentropy',metrics:['accuracy']});
  await model.fit(xs,ys,{epochs:25});
  xs.dispose(); ys.dispose();
  statusText.textContent="Modelo entrenado ‚úÖ";
});

// Funci√≥n para iniciar c√°mara
async function startCamera(){