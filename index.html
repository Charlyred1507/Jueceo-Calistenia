<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Jueceo Calistenia IA</title>

<!-- TensorFlow y Pose Detection -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

<style>
body {
  margin: 0;
  padding: 0;
  background: #111;
  font-family: sans-serif;
  color: white;
  text-align: center;
}
h1 { margin: 10px 0; font-size: 1.8rem; color: #00ff88; }
#container {
  position: relative;
  width: 100%;
  max-width: 640px;
  margin: auto;
}
video, canvas {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: auto;
  border-radius: 12px;
}
#startCamera {
  background: #00ff88;
  color: #111;
  border: none;
  border-radius: 8px;
  padding: 12px 20px;
  font-size: 1rem;
  font-weight: bold;
  margin-top: 15px;
  cursor: pointer;
}
#status {
  margin-top: 10px;
  font-size: 1.2rem;
}
.green { color: #00ff88; }
.red { color: #ff4444; }
.yellow { color: #ffaa00; }
</style>
</head>
<body>

<h1>ðŸ’ª Jueceo Calistenia IA</h1>

<div id="container">
  <video id="video" autoplay playsinline muted></video>
  <canvas id="canvas"></canvas>
</div>

<button id="startCamera">Activar CÃ¡mara</button>
<div id="status" class="yellow">Esperando cÃ¡mara...</div>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const startBtn = document.getElementById("startCamera");
const statusEl = document.getElementById("status");

let detector;
let modelLoaded = false;

// Inicializa el detector de poses
async function loadModel() {
  try {
    await tf.ready();
    detector = await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet, {
      modelType: poseDetection.movenet.modelType.SINGLEPOSE_THUNDER
    });
    modelLoaded = true;
    statusEl.textContent = "ðŸŸ¢ Detector activo";
    statusEl.className = "green";
  } catch (err) {
    console.error("Error cargando el modelo:", err);
    statusEl.textContent = "âš ï¸ Error al cargar el detector";
    statusEl.className = "red";
  }
}

// Inicia la cÃ¡mara tras presionar el botÃ³n
async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment", width: 640, height: 480 }
    });
    video.srcObject = stream;
    await video.play();

    // Ajusta el tamaÃ±o real del canvas
    video.addEventListener("loadedmetadata", () => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      statusEl.textContent = "ðŸŸ¢ CÃ¡mara activa, cargando detector...";
      statusEl.className = "green";
      loadModel().then(startDetection);
    });
  } catch (err) {
    console.error("Error accediendo a la cÃ¡mara:", err);
    statusEl.textContent = "âŒ No se pudo acceder a la cÃ¡mara";
    statusEl.className = "red";
  }
}

// Bucle principal de detecciÃ³n
async function startDetection() {
  if (!modelLoaded) return;

  async function detect() {
    if (video.readyState === 4 && modelLoaded) {
      const poses = await detector.estimatePoses(video);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      if (poses.length > 0) {
        const keypoints = poses[0].keypoints;

        // Dibuja puntos
        keypoints.forEach((kp) => {
          if (kp.score > 0.4) {
            ctx.beginPath();
            ctx.arc(kp.x, kp.y, 6, 0, 2 * Math.PI);
            ctx.fillStyle = "#00ff88";
            ctx.fill();
          }
        });

        // Dibuja conexiones bÃ¡sicas
        const pairs = [
          ["left_shoulder", "left_elbow"],
          ["left_elbow", "left_wrist"],
          ["right_shoulder", "right_elbow"],
          ["right_elbow", "right_wrist"],
          ["left_hip", "left_knee"],
          ["left_knee", "left_ankle"],
          ["right_hip", "right_knee"],
          ["right_knee", "right_ankle"],
          ["left_shoulder", "right_shoulder"],
          ["left_hip", "right_hip"]
        ];

        pairs.forEach(([a, b]) => {
          const p1 = keypoints.find((k) => k.name === a);
          const p2 = keypoints.find((k) => k.name === b);
          if (p1 && p2 && p1.score > 0.4 && p2.score > 0.4) {
            ctx.beginPath();
            ctx.moveTo(p1.x, p1.y);
            ctx.lineTo(p2.x, p2.y);
            ctx.strokeStyle = "#ffaa00";
            ctx.lineWidth = 3;
            ctx.stroke();
          }
        });
      }
    }
    requestAnimationFrame(detect);
  }

  detect();
}

startBtn.addEventListener("click", startCamera);
</script>
</body>
</html>