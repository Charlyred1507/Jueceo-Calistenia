
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Detector de Movimiento Calistenia</title>
<style>
  body {
    margin: 0;
    background: #111;
    color: #fff;
    font-family: 'Poppins', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    overflow: hidden;
  }
  video, canvas {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100%;
    height: auto;
    max-height: 100vh;
    border-radius: 12px;
    object-fit: cover;
  }
  #status {
    position: absolute;
    bottom: 20px;
    background: rgba(0,0,0,0.7);
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 1rem;
    z-index: 10;
  }
  #startBtn, #manualStartBtn {
    position: absolute;
    top: 20px;
    background: #28a745;
    border: none;
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 1rem;
    cursor: pointer;
    z-index: 10;
  }
  #manualStartBtn { top: 60px; background: #007bff; }
  #exerciseSelect {
    position: absolute;
    top: 100px;
    background: #222;
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 1rem;
    z-index: 10;
  }
  #counter {
    position: absolute;
    top: 150px;
    font-size: 1.5rem;
    background: rgba(0,0,0,0.7);
    padding: 8px 16px;
    border-radius: 8px;
    z-index: 10;
  }
</style>
</head>
<body>

<button id="startBtn">Activar C√°mara</button>
<button id="manualStartBtn">Listo para Reps</button>
<select id="exerciseSelect">
  <option value="pushup">Push-ups</option>
  <option value="dip">Fondos</option>
  <option value="squat">Squats</option>
  <option value="pullup">Pull-ups</option>
</select>
<div id="counter">Reps: 0</div>
<video id="video" playsinline autoplay muted></video>
<canvas id="output"></canvas>
<div id="status">Esperando c√°mara...</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('output');
const ctx = canvas.getContext('2d');
const statusEl = document.getElementById('status');
const startBtn = document.getElementById('startBtn');
const manualStartBtn = document.getElementById('manualStartBtn');
const exerciseSelect = document.getElementById('exerciseSelect');
const counterEl = document.getElementById('counter');

let detector;
let reps = 0, up = false;
let currentExercise = exerciseSelect.value;
let inPosition = false;
let readyToStart = false;
let feedbackMessage = "";
let feedbackTimer = null;
let movementBufferY = [];

// Mostrar feedback
function showFeedback(msg, duration=1500){
  if(feedbackMessage !== msg){
    feedbackMessage = msg;
    statusEl.textContent = msg;
    if(feedbackTimer) clearTimeout(feedbackTimer);
    feedbackTimer = setTimeout(()=>{ feedbackMessage=""; statusEl.textContent=""; }, duration);
  }
}

// Cambiar ejercicio
exerciseSelect.addEventListener('change', ()=>{
  currentExercise = exerciseSelect.value;
  reps = 0;
  up = false;
  inPosition = false;
  readyToStart = false;
  movementBufferY = [];
  counterEl.textContent = "Reps: 0";
  showFeedback(`Ejercicio seleccionado: ${currentExercise}`, 2000);
});

// Bot√≥n manual para iniciar reps
manualStartBtn.addEventListener('click', ()=>{
  readyToStart = true;
  inPosition = true;
  showFeedback("üü¢ Usuario listo para reps");
});

// Activar c√°mara trasera
startBtn.addEventListener('click', initCamera);
async function initCamera() {
  showFeedback("Iniciando c√°mara...");
  startBtn.disabled = true;
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { exact: "environment" } }
    });
    video.srcObject = stream;
    await new Promise(res => video.onloadedmetadata = res);
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    showFeedback("C√°mara activa ‚úÖ");
    await initDetector();
    detectPose();
  } catch(err) {
    console.error(err);
    showFeedback("‚ùå No se pudo acceder a la c√°mara");
    startBtn.disabled = false;
  }
}

// Inicializar detector
async function initDetector() {
  showFeedback("Cargando detector...");
  detector = await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet, {
    modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING
  });
  showFeedback("Detector activo ‚úÖ", 1500);
}

// Calcular √°ngulo
function getAngle(a,b,c){
  if(!a || !b || !c) return 180;
  const AB = {x:b.x-a.x, y:b.y-a.y};
  const CB = {x:b.x-c.x, y:b.y-c.y};
  const dot = AB.x*CB.x + AB.y*CB.y;
  const magAB = Math.sqrt(AB.x**2 + AB.y**2);
  const magCB = Math.sqrt(CB.x**2 + CB.y**2);
  return Math.round(Math.acos(dot/(magAB*magCB))*180/Math.PI);
}

// Estabilidad simple
function isStable(y, threshold=12, frames=15){
  if(y === undefined) return false;
  movementBufferY.push(y);
  if(movementBufferY.length>frames) movementBufferY.shift();
  return (Math.max(...movementBufferY)-Math.min(...movementBufferY))<threshold;
}

// Dibuja √°ngulos clave en canvas
function drawAngles(kp){
  ctx.font = "18px Poppins";
  ctx.fillStyle = "yellow";
  if(currentExercise==="pushup" || currentExercise==="dip"){
    const shoulder = kp[11], elbow = kp[13], wrist = kp[15];
    if(shoulder && elbow && wrist) ctx.fillText(getAngle(shoulder,elbow,wrist)+"¬∞", elbow.x+10, elbow.y-10);
  }
  if(currentExercise==="squat"){
    const hip = kp[23], knee = kp[25], ankle = kp[27];
    if(hip && knee && ankle) ctx.fillText(getAngle(hip,knee,ankle)+"¬∞", knee.x+10, knee.y-10);
  }
  if(currentExercise==="pullup"){
    const nose = kp[0], leftHand = kp[9], rightHand = kp[10];
    if(nose && leftHand && rightHand){
      const yHands = (leftHand.y + rightHand.y)/2;
      const hPerc = Math.round(100*(nose.y - yHands)/(nose.y));
      ctx.fillText(hPerc+"%", nose.x+10, nose.y-10);
    }
  }
}

// Detecta reps y posici√≥n inicial
function detectReps(kp){
  let angle=0;
  let reason = "";

  const shoulder = kp[11], elbow = kp[13], wrist = kp[15];
  const hip = kp[23], knee = kp[25], ankle = kp[27];
  const nose = kp[0], leftHand = kp[9], rightHand = kp[10];

  // Feedback de posici√≥n inicial
  if(!inPosition){
    switch(currentExercise){
      case "pushup":
        if(shoulder && elbow && wrist){
          angle = getAngle(shoulder,elbow,wrist);
          if(angle>150 && Math.abs(shoulder.y-wrist.y)<30 && isStable((shoulder.y+elbow.y)/2)){
            inPosition = true; readyToStart=true;
            showFeedback("üü¢ Listo para empezar reps");
          } else {
            showFeedback("Ajusta brazos rectos y quieto para iniciar");
          }
        }
        break;
      case "dip":
        if(shoulder && elbow && wrist && hip){
          angle = getAngle(shoulder,elbow,wrist);
          if(angle>150 && hip.y>shoulder.y && isStable((hip.y+elbow.y)/2)){
            inPosition = true; readyToStart=true;
            showFeedback("üü¢ Listo para empezar reps");
          } else {
            showFeedback("Mant√©n brazos rectos y cuerpo arriba");
          }
        }
        break;
      case "squat":
        if(hip && knee && ankle && shoulder){
          angle = getAngle(hip,knee,ankle);
          if(angle>150 && Math.abs(hip.x-shoulder.x)<30 && isStable((hip.y+knee.y)/2)){
            inPosition = true; readyToStart=true;
            showFeedback("üü¢ Listo para empezar reps");
          } else {
            showFeedback("Estira piernas, hombros alineados");
          }
        }
        break;
      case "pullup":
        if(nose && leftHand && rightHand){
          const yHands = (leftHand.y + rightHand.y)/2;
          if(nose.y>yHands+60 && isStable((nose.y+yHands)/2)){
            inPosition = true; readyToStart=true;
            showFeedback("üü¢ Listo para empezar reps");
          } else {
            showFeedback("Cuelgate completamente antes de iniciar");
          }
        }
        break;
    }
  }

  // Detectar reps solo si ya est√° listo
  if(readyToStart){
    switch(currentExercise){
      case "pushup":
        angle = getAngle(shoulder,elbow,wrist);
        if(angle<80 && !up) up=true;
        if(angle>160 && up){ reps++; up=false; showFeedback("‚úÖ Repetici√≥n v√°lida"); }
        break;
      case "dip":
        angle = getAngle(shoulder,elbow,wrist);
        if(angle<90 && !up) up=true;
        if(angle>160 && up){ reps++; up=false; showFeedback("‚úÖ Repetici√≥n v√°lida"); }
        break;
      case "squat":
        angle = getAngle(hip,knee,ankle);
        if(angle<90 && !up) up=true;
        if