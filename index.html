<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Jueceo Calistenia IA - MoveNet</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.3.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@0.0.7/dist/pose-detection.min.js"></script>
<style>
  body { background: #111; color: white; text-align: center; font-family: sans-serif; }
  video, canvas { width: 100%; height: auto; border-radius: 12px; margin-top: 20px; }
  #status { font-size: 1.5rem; margin-top: 20px; }
  .green { color: #00ff88; }
  .red { color: #ff4444; }
</style>
</head>
<body>
<h1>üí™ Jueceo Calistenia IA - MoveNet</h1>

<video id="video" playsinline autoplay muted></video>
<canvas id="output"></canvas>
<div id="status" class="red">Toca la pantalla para iniciar la c√°mara...</div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('output');
const ctx = canvas.getContext('2d');
const statusText = document.getElementById('status');

let detector;

function calcAngle(a,b,c){
  const radians = Math.atan2(c.y-b.y, c.x-b.x) - Math.atan2(a.y-b.y, a.x-b.x);
  let angle = Math.abs(radians*180/Math.PI);
  if(angle>180) angle = 360-angle;
  return angle;
}

function drawPose(pose){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(video,0,0,canvas.width,canvas.height);

  if(pose.keypoints){
    ctx.fillStyle = "#FF3366";
    ctx.strokeStyle = "#00FFAA";
    ctx.lineWidth = 2;

    pose.keypoints.forEach(kp=>{
      if(kp.score>0.3){
        ctx.beginPath();
        ctx.arc(kp.x, kp.y, 5, 0, 2*Math.PI);
        ctx.fill();
      }
    });

    const leftShoulder = pose.keypoints.find(k=>k.name==='left_shoulder');
    const leftElbow = pose.keypoints.find(k=>k.name==='left_elbow');
    const leftWrist = pose.keypoints.find(k=>k.name==='left_wrist');

    if(leftShoulder && leftElbow && leftWrist){
      ctx.beginPath();
      ctx.moveTo(leftShoulder.x,leftShoulder.y);
      ctx.lineTo(leftElbow.x,leftElbow.y);
      ctx.lineTo(leftWrist.x,leftWrist.y);
      ctx.stroke();

      const angle = calcAngle(leftShoulder, leftElbow, leftWrist);
      if(angle<100){
        statusText.textContent="‚úÖ ¬°90 grados alcanzados!";
        statusText.className="green";
      }else{
        statusText.textContent="‚¨áÔ∏è Baja m√°s";
        statusText.className="red";
      }
    }
  }
}

async function startCamera(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: "environment" } } // c√°mara trasera
    });
    video.srcObject = stream;
    await video.play();

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    detector = await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet);

    statusText.textContent="C√°mara activada ‚úÖ";

    async function detectPose(){
      const poses = await detector.estimatePoses(video);
      if(poses.length>0) drawPose(poses[0]);
      else ctx.drawImage(video,0,0,canvas.width,canvas.height);
      requestAnimationFrame(detectPose);
    }
    detectPose();

  }catch(err){
    statusText.textContent="‚ùå No se pudo acceder a la c√°mara";
    console.error(err);
  }
}

document.body.addEventListener('click', startCamera, {once:true});
</script>
</body>
</html>